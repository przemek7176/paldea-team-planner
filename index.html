<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>paldea-team-planner</title>

    <!-- PokeAPI 404 Fix (safe, fetch-only; runs BEFORE the app boots) -->
    <script>
      (() => {
        const DEV = new URLSearchParams(location.search).get('dev') === '1';
        const log = (...a) => DEV && console.debug('[PokeFix]', ...a);
        const isPokeHost = (h) => /(^|\.)pokeapi\.co$/i.test(h);
        const normalize = (s) => String(s || '').toLowerCase().trim().replace(/:\d+$/, '');

        // Base species -> default form that exists under /pokemon/
        const MAP = {
          lycanroc: 'lycanroc-midday',
          oricorio: 'oricorio-baile',
          maushold: 'maushold-family-of-three',
          dudunsparce: 'dudunsparce-two-segment',
          indeedee: 'indeedee-male',
          eiscue: 'eiscue-ice',
          tatsugiri: 'tatsugiri-curly',
          palafin: 'palafin-zero',
          toxtricity: 'toxtricity-amped',
          basculin: 'basculin-red-striped',
          squawkabilly: 'squawkabilly-green-plumage',
          mimikyu: 'mimikyu-disguised',
          oinkologne: 'oinkologne' // base entry exists
        };

        const cache = new Map();
        const origFetch = window.fetch.bind(window);

        async function resolveDefaultVariety(speciesSlug) {
          const key = normalize(speciesSlug);
          if (MAP[key]) return MAP[key];
          if (cache.has(key)) return cache.get(key);
          const url = `https://pokeapi.co/api/v2/pokemon-species/${encodeURIComponent(key)}/`;
          const r = await origFetch(url);
          if (!r.ok) throw new Error(`species lookup ${key} -> ${r.status}`);
          const j = await r.json();
          const v = (j.varieties || []).find(v => v.is_default) || (j.varieties || [])[0];
          const name = v?.pokemon?.name || key;
          cache.set(key, name);
          return name;
        }

        window.fetch = async function(input, init) {
          try {
            let req = input instanceof Request ? input : new Request(input, init);
            let u = new URL(req.url, location.href);

            // Only touch Pok√©API /pokemon/* calls
            if (isPokeHost(u.hostname) && /^\/api\/v2\/pokemon\/[^/]+\/?$/i.test(u.pathname)) {
              const raw = decodeURIComponent(u.pathname.split('/').filter(Boolean).pop());
              const key = normalize(raw);
              const canonical = MAP[key];

              // Pre-rewrite to known default form, otherwise ensure trailing slash
              if (canonical && canonical !== raw) {
                u.pathname = `/api/v2/pokemon/${encodeURIComponent(canonical)}/`;
                req = new Request(u.toString(), req);
                log('rewrite', raw, '‚Üí', canonical);
              } else if (!u.pathname.endsWith('/')) {
                u.pathname += '/';
                req = new Request(u.toString(), req);
              }
            }

            // First attempt
            let res = await origFetch(req);
            if (res.status !== 404) return res;

            // If still 404 on /pokemon/<slug>/, resolve via species -> default variety
            const url404 = new URL(res.url);
            if (isPokeHost(url404.hostname) && /^\/api\/v2\/pokemon\/[^/]+\/$/i.test(url404.pathname)) {
              const slug = normalize(url404.pathname.split('/').filter(Boolean).pop());
              try {
                const def = await resolveDefaultVariety(slug);
                if (def && def !== slug) {
                  const fixed = new Request(
                    `https://pokeapi.co/api/v2/pokemon/${encodeURIComponent(def)}/`,
                    req
                  );
                  log('fallback', slug, '=>', def);
                  return await origFetch(fixed);
                }
              } catch (_) { /* fall through to original 404 */ }
            }

            return res;
          } catch (err) {
            console && console.warn && console.warn('[PokeFix] unexpected error:', err);
            return origFetch(input, init);
          }
        };
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <!-- Vite entry -->
    <script type="module" src="/src/main.tsx"></script>

    <!-- === DevKit (gated by ?dev=1) ==================================== -->
    <div id="dev-panel" style="display:none;position:fixed;right:8px;bottom:8px;z-index:999999;background:#111;color:#fff;padding:8px 10px;border-radius:8px;font:12px ui-monospace,Menlo,Consolas,monospace;box-shadow:0 4px 12px rgba(0,0,0,.4)">
      <button id="dev-selftest" style="margin-right:6px">Self-Test</button>
      <button id="dev-clear">Clear cache</button>
    </div>
    <script>
      (() => {
        const DEV = /\bdev=1\b/.test(location.search);
        if (!DEV) return;

        // 1) Fatal error overlay
        const showOverlay = (title, msg, stack) => {
          const el = document.createElement('div');
          el.id = 'fatal-overlay';
          el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;font:14px ui-monospace,Menlo,Consolas,monospace;z-index:1000000;padding:24px;overflow:auto';
          el.innerHTML = `<div style="max-width:1000px;margin:0 auto">
            <h2 style="margin:0 0 8px;font-size:18px">üí• ${title}</h2>
            <pre style="white-space:pre-wrap;margin:0 0 8px">${msg}</pre>
            <pre style="white-space:pre-wrap;opacity:.8">${stack || ''}</pre>
            <button id="fatal-close" style="margin-top:12px">Dismiss</button>
          </div>`;
          document.body.appendChild(el);
          document.getElementById('fatal-close').onclick = () => el.remove();
          console.error('[FATAL]', title, msg, stack);
        };
        window.addEventListener('error', e =>
          showOverlay('Unhandled Error', String(e.message || e.error), e.error?.stack)
        );
        window.addEventListener('unhandledrejection', e => {
          const r = e.reason || {};
          showOverlay('Unhandled Promise Rejection', String(r.message || r || 'Unknown'), r.stack);
        });

        // 2) Debug panel
        const panel = document.getElementById('dev-panel');
        panel.style.display = 'block';
        document.getElementById('dev-clear').onclick = () => { localStorage.clear(); location.reload(); };

        // 3) Self-Test (non-intrusive)
        async function runSelfTest() {
          const results = [];
          const push = (name, ok, note='') => results.push({name, ok, note});

          try {
            push('Root node exists', !!document.getElementById('root'));

            const keys = ['ownedMoves','ownedMonIds','monMoves','monLevels'];
            const bad = [];
            for (const k of keys) {
              const v = localStorage.getItem(k);
              if (!v) continue;
              try { JSON.parse(v); } catch { bad.push(k); }
            }
            push('localStorage JSON valid', bad.length === 0, bad.length ? ('Bad: '+bad.join(',')) : '');

            if (typeof window.ensureTMSet === 'function') {
              try { await window.ensureTMSet(); push('TM catalog loaded', !!window._tmCatalog && window._tmCatalog.size > 0); }
              catch (e) { push('TM catalog loaded', false, String(e)); }
            } else {
              push('TM catalog (optional check)', true, 'ensureTMSet not exposed');
            }

            try {
              const r = await fetch('https://pokeapi.co/api/v2/pokemon/pikachu/');
              push('Pok√©API reachable', r.ok, 'status '+r.status);
            } catch (e) {
              push('Pok√©API reachable', false, String(e));
            }

            console.table(results);
            alert(results.every(r=>r.ok) ? 'Self-Test passed ‚úÖ' : 'Self-Test found issues ‚ùå (see console)');
          } catch (e) {
            console.error('Self-Test fatal', e);
            alert('Self-Test crashed. See console.');
          }
        }
        document.getElementById('dev-selftest').onclick = runSelfTest;
      })();
    </script>
    <!-- ================================================================ -->
  </body>
</html>
