<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>paldea-team-planner</title>

    <!-- PokeAPI 404 hotfix (must run BEFORE the app boots) -->
    <script>
      (() => {
        const DEV = new URLSearchParams(location.search).get('dev') === '1';
        const log = (...a) => DEV && console.debug('[PokeFix]', ...a);
        const isPokeHost = (h) => /(^|\.)pokeapi\.co$/i.test(h);
        const normalize = (s) => String(s || '').toLowerCase().trim().replace(/:\d+$/, '');

        // base species -> default form that actually exists under /pokemon/
        const MAP = {
          lycanroc: 'lycanroc-midday',
          oricorio: 'oricorio-baile',
          maushold: 'maushold-family-of-three',
          dudunsparce: 'dudunsparce-two-segment',
          indeedee: 'indeedee-male',
          eiscue: 'eiscue-ice',
          tatsugiri: 'tatsugiri-curly',
          palafin: 'palafin-zero',
          toxtricity: 'toxtricity-amped',
          basculin: 'basculin-red-striped',
          squawkabilly: 'squawkabilly-green-plumage',
          mimikyu: 'mimikyu-disguised',
          oinkologne: 'oinkologne'
        };

        function rewritePokemonUrl(u) {
          const m = u.pathname.match(/^\/api\/v2\/pokemon\/([^/]+)(\/?)$/i);
          if (!m) return false;
          const raw = decodeURIComponent(m[1]);
          const key = normalize(raw);
          const mapped = MAP[key] || key;
          const needMap = mapped !== raw;
          const needSlash = m[2] !== '/';
          if (needMap || needSlash) {
            u.pathname = `/api/v2/pokemon/${encodeURIComponent(mapped)}/`;
            log('rewrite', raw, '->', mapped, '(slash:', needSlash, 'map:', needMap + ')');
            return true;
          }
          return false;
        }

        async function resolveDefaultVariety(speciesSlug) {
          const key = normalize(speciesSlug);
          if (MAP[key]) return MAP[key];
          const r = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${encodeURIComponent(key)}/`);
          if (!r.ok) throw new Error('species lookup ' + key);
          const j = await r.json();
          const v = (j.varieties || []).find(v => v.is_default) || (j.varieties || [])[0];
          return v?.pokemon?.name || key;
        }

        // ---- Patch Request() so ANY caller is rewritten before fetch/XHR see it ----
        const OR = window.Request;
        function PatchedRequest(input, init) {
          let url = input instanceof OR ? input.url : String(input);
          try {
            const u = new URL(url, location.href);
            if (isPokeHost(u.hostname) && /^\/api\/v2\/pokemon\//i.test(u.pathname)) {
              rewritePokemonUrl(u);
              url = u.toString();
            }
          } catch {}
          return new OR(url, input instanceof OR ? input : init);
        }
        PatchedRequest.prototype = OR.prototype;
        window.Request = PatchedRequest;

        // ---- fetch interceptor (adds speciesâ†’variety fallback) ----
        const OF = window.fetch.bind(window);
        window.fetch = async (input, init) => {
          const req = input instanceof Request ? input : new Request(String(input), init);
          let res = await OF(req);

          if (
            res.status === 404 &&
            isPokeHost(new URL(res.url).hostname) &&
            /^\/api\/v2\/pokemon\//i.test(new URL(res.url).pathname)
          ) {
            const slug = normalize(new URL(res.url).pathname.split('/').filter(Boolean).pop());
            try {
              const def = await resolveDefaultVariety(slug);
              if (def && def !== slug) {
                const fixed = `https://pokeapi.co/api/v2/pokemon/${def}/`;
                log('fallback', slug, '=>', def);
                res = await OF(fixed, init);
              }
            } catch { /* ignore */ }
          }
          return res;
        };

        // ---- XHR interceptor (rewrite URL before sending) ----
        const XO = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function (method, url, ...rest) {
          try {
            const u = new URL(url, location.href);
            if (isPokeHost(u.hostname) && /^\/api\/v2\/pokemon\//i.test(u.pathname)) {
              rewritePokemonUrl(u);
              url = u.toString();
            }
          } catch {}
          return XO.call(this, method, url, ...rest);
        };
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- DevKit: crash overlay + self-test (only with ?dev=1) -->
    <script>
      (function () {
        if (new URLSearchParams(location.search).get('dev') !== '1') return;

        const show = (title, msg, stack) => {
          const el = document.createElement('div');
          el.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;font:14px ui-monospace,Menlo,Consolas;z-index:999999;padding:24px;overflow:auto';
          el.innerHTML = `<div style="max-width:1000px;margin:0 auto">
            <h2 style="margin:0 0 8px;font-size:18px">ðŸ’¥ ${title}</h2>
            <pre style="white-space:pre-wrap;margin:0 0 8px">${msg}</pre>
            <pre style="white-space:pre-wrap;opacity:.8">${stack || ''}</pre>
            <button id="fatal-close" style="margin-top:12px">Dismiss</button></div>`;
          document.body.appendChild(el);
          document.getElementById('fatal-close').onclick = () => el.remove();
          console.error('[FATAL]', title, msg, stack);
        };

        window.addEventListener('error', (e) => show('Unhandled Error', String(e.message || e.error), e.error?.stack));
        window.addEventListener('unhandledrejection', (e) => {
          const r = e.reason || {};
          show('Unhandled Promise Rejection', String(r.message || r || 'Unknown'), r.stack);
        });

        const panel = document.createElement('div');
        panel.style.cssText = 'position:fixed;right:8px;bottom:8px;z-index:999999;background:#111;color:#fff;padding:8px 10px;border-radius:8px;font:12px ui-monospace,Menlo,Consolas';
        panel.innerHTML = '<button id="run-st">Self-Test</button> <button id="clr">Clear cache</button>';
        document.body.appendChild(panel);
        document.getElementById('clr').onclick = () => { localStorage.clear(); location.reload(); };
        document.getElementById('run-st').onclick = () => {
          console.table([
            { name: 'Root node exists', ok: !!document.getElementById('root') },
            { name: 'fetch patched', ok: ('' + window.fetch).includes('PokeFix') },
            { name: 'Request patched', ok: window.Request && ('' + window.Request).includes('PatchedRequest') }
          ]);
          alert('Self-Test done. See console.');
        };
      })();
    </script>

    <!-- Vite entry -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
